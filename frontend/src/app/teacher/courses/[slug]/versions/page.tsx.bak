"use client";
import { useParams, useRouter } from "next/navigation";
import { useState } from "react";
import Link from "next/link";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import {
    ArrowLeft,
    Plus,
    FileText,
    CheckCircle,
    Info,
    Clock,
    XCircle,
    Archive,
} from "lucide-react";
import { courseService } from "@/services/courses/course.service";
import { courseVersionService } from "@/services/courses/course-version.service";
import { CourseDetailResponse, CourseVersionResponse } from "@/services/courses/course.types";
import { VersionCard } from "@/core/components/teacher/courses/VersionCard";
import { toast } from "sonner";

export default function CourseVersionsPage() {
    const params = useParams();
    const router = useRouter();
    const queryClient = useQueryClient();
    const slug = params.slug as string;
    const [showDeleted, setShowDeleted] = useState(false);
    const [statusFilter, setStatusFilter] = useState<string>("ALL");

    // Fetch course details
    const { data: course } = useQuery<CourseDetailResponse>({
        queryKey: ["course-detail", slug],
        queryFn: () => courseService.getCourseBySlug(slug),
    });

    // Fetch course versions
    const { data: versions, isLoading: loadingVersions } = useQuery<CourseVersionResponse[]>({
        queryKey: ["course-versions", course?.id],
        queryFn: () => courseVersionService.getCourseVersions(course!.id),
        enabled: !!course?.id,
    });

    // Fetch deleted versions
    const { data: deletedVersions } = useQuery<CourseVersionResponse[]>({
        queryKey: ["deleted-versions", course?.id],
        queryFn: () => courseVersionService.getDeletedCourseVersions(course!.id),
        enabled: !!course?.id && showDeleted,
    });

    // Submit for approval mutation
    const submitForApproval = useMutation({
        mutationFn: (versionId: number) =>
            courseVersionService.submitApproval(course!.id, versionId),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["course-versions"] });
            toast.success("Version submitted for approval successfully");
        },
        onError: (error: any) => {
            toast.error(error?.message || "Failed to submit version");
        },
    });

    // Publish version mutation
    const publishVersion = useMutation({
        mutationFn: (versionId: number) =>
            courseVersionService.publishCourseVersion(course!.id, versionId),
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ["course-versions"] });
            toast.success("Version published successfully! Your course is now live.");
        },
        onError: (error: any) => {
            toast.error(error?.message || "Failed to publish version");
        },
    });

    const handleDelete = async (versionId: number) => {
        if (!confirm("Are you sure you want to delete this version? This action cannot be undone.")) {
            return;
        }
        try {
            await courseVersionService.deleteCourseVersion(course!.id, versionId);
            queryClient.invalidateQueries({ queryKey: ["course-versions"] });
            toast.success("Version deleted successfully");
        } catch (error: any) {
            toast.error(error?.message || "Failed to delete version");
        }
    };

    if (!course) {
        return (
            <div className="flex items-center justify-center min-h-[60vh]">
                <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin" />
            </div>
        );
    }

    const displayVersions = showDeleted ? deletedVersions : versions;
    const filteredVersions = statusFilter === "ALL"
        ? displayVersions
        : displayVersions?.filter(v => v.status === statusFilter);

    return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
                {/* Header */}
                <div className="flex items-start justify-between gap-4">
                    <div className="flex items-start gap-4">
                        <Link
                            href={`/teacher/courses/${slug}`}
                            className="p-3 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors mt-1 group"
                        >
                            <ArrowLeft className="w-5 h-5 text-slate-600 dark:text-slate-400 group-hover:text-indigo-600 dark:group-hover:text-indigo-400" />
                        </Link>
                        <div>
                            <h1 className="text-4xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">
                                Version History
                            </h1>
                            <p className="text-lg text-slate-600 dark:text-slate-400">{course.title}</p>
                        </div>
                    </div>
                    <Link
                        href={`/teacher/courses/${slug}/versions/create`}
                        className="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl font-medium transition-all shadow-lg shadow-indigo-600/30 hover:shadow-xl hover:shadow-indigo-600/40 hover:scale-105"
                    >
                        <Plus className="w-5 h-5" />
                        Create New Version
                    </Link>
                </div>

                {/* Info Card */}
                <div className="bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 border-2 border-indigo-200 dark:border-indigo-800 rounded-2xl p-6 shadow-lg">
                    <div className="flex items-start gap-4">
                        <div className="p-3 bg-indigo-600 dark:bg-indigo-500 rounded-xl shadow-lg">
                            <Info className="w-6 h-6 text-white" />
                        </div>
                        <div className="flex-1">
                            <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">
                                Version Management Workflow
                            </h3>
                            <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
                                Each version goes through a review process before becoming live. Track all changes
                                and maintain course quality with our structured approval workflow.
                            </p>

                            {/* Status Flow */}
                            <div className="flex flex-wrap items-center gap-3">
                                <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-800 rounded-lg">
                                    <FileText className="w-4 h-4 text-slate-600 dark:text-slate-400" />
                                    <span className="text-xs font-semibold text-slate-700 dark:text-slate-300">
                                        DRAFT
                                    </span>
                                </div>
                                <ArrowLeft className="w-4 h-4 text-slate-400 rotate-180" />

                                <div className="flex items-center gap-2 px-3 py-1.5 bg-amber-100 dark:bg-amber-900/30 rounded-lg">
                                    <Clock className="w-4 h-4 text-amber-600 dark:text-amber-400" />
                                    <span className="text-xs font-semibold text-amber-700 dark:text-amber-400">
                                        PENDING
                                    </span>
                                </div>
                                <ArrowLeft className="w-4 h-4 text-slate-400 rotate-180" />

                                <div className="flex items-center gap-2 px-3 py-1.5 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                                    <CheckCircle className="w-4 h-4 text-blue-600 dark:text-blue-400" />
                                    <span className="text-xs font-semibold text-blue-700 dark:text-blue-400">
                                        APPROVED
                                    </span>
                                </div>
                                <ArrowLeft className="w-4 h-4 text-slate-400 rotate-180" />

                                <div className="flex items-center gap-2 px-3 py-1.5 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg">
                                    <CheckCircle className="w-4 h-4 text-emerald-600 dark:text-emerald-400" />
                                    <span className="text-xs font-semibold text-emerald-700 dark:text-emerald-400">
                                        PUBLISHED
                                    </span>
                                </div>
                            </div>

                            <div className="mt-4 pt-4 border-t border-indigo-200 dark:border-indigo-800 grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
                                <div className="flex items-start gap-2">
                                    <div className="w-1.5 h-1.5 rounded-full bg-emerald-600 mt-1.5" />
                                    <p className="text-slate-600 dark:text-slate-400">
                                        <span className="font-semibold">ARCHIVED:</span> Previously published versions
                                        that students can still access
                                    </p>
                                </div>
                                <div className="flex items-start gap-2">
                                    <div className="w-1.5 h-1.5 rounded-full bg-red-600 mt-1.5" />
                                    <p className="text-slate-600 dark:text-slate-400">
                                        <span className="font-semibold">Note:</span> Cannot delete PUBLISHED or ARCHIVED
                                        versions
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Filter: Show Deleted */}
                <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 bg-white dark:bg-slate-800 rounded-2xl p-4 border border-slate-200 dark:border-slate-700">
                    <label htmlFor="showDeleted" className="flex items-center gap-3 cursor-pointer">
                        <input
                            type="checkbox"
                            id="showDeleted"
                            checked={showDeleted}
                            onChange={(e) => setShowDeleted(e.target.checked)}
                            className="w-5 h-5 rounded border-slate-300 dark:border-slate-600 text-indigo-600 focus:ring-indigo-500"
                        />
                        <span className="text-sm font-medium text-slate-700 dark:text-slate-300">
                            Show deleted versions
                        </span>
                    </label>

                    {/* Status Filter */}
                    <div className="flex items-center gap-3">
                        <label className="text-sm font-medium text-slate-700 dark:text-slate-300">
                            Filter by status:
                        </label>
                        <select
                            value={statusFilter}
                            onChange={(e) => setStatusFilter(e.target.value)}
                            className="px-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-slate-900 dark:text-white text-sm"
                        >
                            <option value="ALL">All Status</option>
                            <option value="DRAFT">Draft</option>
                            <option value="PENDING">Pending</option>
                            <option value="APPROVED">Approved</option>
                            <option value="REJECTED">Rejected</option>
                            <option value="PUBLISHED">Published</option>
                            <option value="ARCHIVED">Archived</option>
                        </select>
                    </div>

                    {showDeleted && deletedVersions && (
                        <span className="text-sm text-slate-500 dark:text-slate-400">
                            {deletedVersions.length} deleted version(s)
                        </span>
                    )}
                </div>

                {/* Versions List */}
                {loadingVersions ? (
                    <div className="flex justify-center py-16">
                        <div className="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin" />
                    </div>
                ) : filteredVersions && filteredVersions.length > 0 ? (
                    <div className="space-y-6">
                        {filteredVersions.map((version) => (
                            <VersionCard
                                key={version.id}
                                version={version}
                                courseSlug={slug}
                                onSubmitForApproval={(versionId) => submitForApproval.mutate(versionId)}
                                onPublish={(versionId) => publishVersion.mutate(versionId)}
                                onDelete={handleDelete}
                                isSubmitting={submitForApproval.isPending}
                                isPublishing={publishVersion.isPending}
                            />
                        ))}
                    </div>
                ) : (
                    <div className="bg-white dark:bg-slate-800 rounded-2xl p-16 text-center border-2 border-dashed border-slate-300 dark:border-slate-700">
                        <div className="w-20 h-20 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-6">
                            <FileText className="w-10 h-10 text-slate-400" />
                        </div>
                        <h3 className="text-2xl font-bold text-slate-900 dark:text-white mb-3">
                            {showDeleted ? "No deleted versions" : "No versions yet"}
                        </h3>
                        <p className="text-slate-600 dark:text-slate-400 mb-8 max-w-md mx-auto">
                            {showDeleted
                                ? "You don't have any deleted versions for this course."
                                : "Create your first version to start building your course content."}
                        </p>
                        {!showDeleted && (
                            <Link
                                href={`/teacher/courses/${slug}/versions/create`}
                                className="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-medium transition-all"
                            >
                                <Plus className="w-5 h-5" />
                                Create First Version
                            </Link>
                        )}
                    </div>
                )}
            </div>
        </div>
    );
}
