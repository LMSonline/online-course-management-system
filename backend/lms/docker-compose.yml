services:
  postgres:
    image: ${POSTGRES_IMAGE}
    container_name: ${POSTGRES_CONTAINER_NAME}
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "${POSTGRES_PORT}:5432"
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - D:/lms-storage:/lms-storage

    networks:
      - lms-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${APP_CONTAINER_NAME}
    ports:
      - "${APP_PORT}:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}

      SPRING_JPA_HIBERNATE_DDL_AUTO: ${SPRING_JPA_HIBERNATE_DDL_AUTO}
      SPRING_JPA_SHOW_SQL: ${SPRING_JPA_SHOW_SQL}

      SPRING_MAIL_HOST: ${SPRING_MAIL_HOST}
      SPRING_MAIL_PORT: ${SPRING_MAIL_PORT}
      SPRING_MAIL_USERNAME: ${SPRING_MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${SPRING_MAIL_PASSWORD}

      APP_BASE_URL: ${APP_BASE_URL}
      APP_FRONTEND_URL: ${APP_FRONTEND_URL}

      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION}
      JWT_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION}

      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}

      MINIO_URL: http://minio:9000
      MINIO_BUCKET: lms-videos
      MINIO_USERNAME: ${MINIO_ROOT_USER}
      MINIO_PASSWORD: ${MINIO_ROOT_PASSWORD}

      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_DEFAULT_USER:-guest}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_DEFAULT_PASS:-guest}

      ZALO_PAY_APP_ID: ${ZALO_PAY_APP_ID}
      ZALO_PAY_KEY1: ${ZALO_PAY_KEY1}
      ZALO_PAY_KEY2: ${ZALO_PAY_KEY2}
      ZALO_PAY_ENDPOINT_BASE: ${ZALO_PAY_ENDPOINT_BASE}
      ZALO_PAY_CREATE_ORDER_ENDPOINT: ${ZALO_PAY_CREATE_ORDER_ENDPOINT}
      ZALO_PAY_QUERY_ORDER_ENDPOINT: ${ZALO_PAY_QUERY_ORDER_ENDPOINT}
      ZALO_PAY_REFUND_ORDER_ENDPOINT:  ${ZALO_PAY_REFUND_ORDER_ENDPOINT}
      ZALO_PAY_REFUND_QUERY_ORDER_ENDPOINT: ${ZALO_PAY_REFUND_QUERY_ORDER_ENDPOINT}
      ZALO_PAY_CALLBACK_URL: ${ZALO_PAY_CALLBACK_URL}
      ZALO_PAY_BANKS_ENDPOINT: ${ZALO_PAY_BANKS_ENDPOINT}

    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - lms-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  pgadmin:
    image: ${PGADMIN_IMAGE}
    container_name: ${PGADMIN_CONTAINER_NAME}
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
    ports:
      - "${PGADMIN_PORT}:80"
    restart: always
    networks:
      - lms-network
    depends_on:
      - postgres

  minio:
    image: ${MINIO_IMAGE}
    container_name: ${MINIO_CONTAINER_NAME}
    restart: unless-stopped
    networks:
      - lms-network
    volumes:
      - minio-data:/data
    environment:
      MINIO_BUCKET_VIDEOS: ${MINIO_BUCKET_VIDEOS}
      MINIO_BUCKET_IMAGES: ${MINIO_BUCKET_IMAGES}
      MINIO_BUCKET_DOCUMENTS: ${MINIO_BUCKET_DOCUMENTS}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "${MINIO_PORT}:9000"
      - "${MINIO_UI_PORT}:9090"
    command: minio server /data --console-address ":9090"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/minio/health/live || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: ${RABBITMQ_IMAGE:-rabbitmq:3-management}
    container_name: ${RABBITMQ_CONTAINER_NAME:-rabbitmq}
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS:-guest}
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_UI_PORT:-15672}:15672" # management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - lms-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "rabbitmqctl -q status || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # rs:
  #   build:
  #     context: ../recommendation-service         
  #     dockerfile: Dockerfile  
  #   container_name: rs-service
  #   ports:
  #     - "8002:8002"           
  #   environment:
  #     # Optional: DB config for offline training scripts (can reuse LMS DB)
  #     RS_DB_HOST: postgres
  #     RS_DB_PORT: 5432
  #     RS_DB_NAME: ${POSTGRES_DB}
  #     RS_DB_USER: ${POSTGRES_USER}
  #     RS_DB_PASSWORD: ${POSTGRES_PASSWORD}
  #     RS_MODELS_DIR: /models
  #   networks:
  #     - lms-network          
  #   restart: unless-stopped
  #   volumes:
  #     - rs-models:/models

  chatbot:
    build:
      context: ../chatbot-service
      dockerfile: Dockerfile
    container_name: chatbot-service
    ports:
      - "8003:8003"
    env_file:
      - ../chatbot-service/.env
    environment:

      VECTOR_STORE_BACKEND: faiss
      VECTOR_STORE_DIR: /vector_store
    volumes:
      - chatbot-vectors:/vector_store
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - lms-network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  minio-data:
    driver: local
  rabbitmq-data:
    driver: local
  rs-models:
    driver: local
  chatbot-vectors:
    driver: local

networks:
  lms-network:
    driver: bridge

